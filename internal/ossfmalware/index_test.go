package ossfmalware

import (
	"testing"
)

func TestNormalizePythonPackageName(t *testing.T) {
	tests := []struct {
		input    string
		expected string
	}{
		{"requests", "requests"},
		{"Requests", "requests"},
		{"REQUESTS", "requests"},
		{"my-package", "my-package"},
		{"my_package", "my-package"},
		{"my.package", "my-package"},
		{"My_Package", "my-package"},
		{"django-rest-framework", "django-rest-framework"},
		{"Django_REST_Framework", "django-rest-framework"},
		{"package--name", "package-name"},
		{"package__name", "package-name"},
		{"package..name", "package-name"},
		{"package._-name", "package-name"},
	}

	for _, tc := range tests {
		t.Run(tc.input, func(t *testing.T) {
			result := normalizePythonPackageName(tc.input)
			if result != tc.expected {
				t.Errorf("normalizePythonPackageName(%q) = %q, want %q", tc.input, result, tc.expected)
			}
		})
	}
}

func TestGetPythonNameVariants(t *testing.T) {
	tests := []struct {
		input    string
		expected []string
	}{
		{
			"requests",
			[]string{"requests", "Requests"},
		},
		{
			"my-package",
			[]string{"my-package", "my_package", "My-package"},
		},
		{
			"Django",
			[]string{"Django", "django", "Django"},
		},
	}

	for _, tc := range tests {
		t.Run(tc.input, func(t *testing.T) {
			result := getPythonNameVariants(tc.input)

			// Check that all expected variants are present
			for _, expected := range tc.expected {
				found := false
				for _, v := range result {
					if v == expected {
						found = true
						break
					}
				}
				if !found {
					t.Errorf("getPythonNameVariants(%q) missing expected variant %q, got %v", tc.input, expected, result)
				}
			}
		})
	}
}

func TestLookupPyPINormalization(t *testing.T) {
	// This test verifies that the normalization logic works correctly
	// by checking that different name variants would match

	// Test that normalized names match
	variants := getPythonNameVariants("my-package")

	// Should contain both hyphen and underscore versions
	hasHyphen := false
	hasUnderscore := false
	for _, v := range variants {
		if v == "my-package" {
			hasHyphen = true
		}
		if v == "my_package" {
			hasUnderscore = true
		}
	}

	if !hasHyphen {
		t.Error("variants should include 'my-package'")
	}
	if !hasUnderscore {
		t.Error("variants should include 'my_package'")
	}
}
